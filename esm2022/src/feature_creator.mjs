import { capitalize } from './helpers';
import { isPlainObject } from './meta-reducers/utils';
import { createFeatureSelector, createSelector, } from './selector';
/**
 * @description
 * A function that accepts a feature name and a feature reducer, and creates
 * a feature selector and a selector for each feature state property.
 * This function also provides the ability to add extra selectors to
 * the feature object.
 *
 * @param featureConfig An object that contains a feature name and a feature
 * reducer as required, and extra selectors factory as an optional argument.
 * @returns An object that contains a feature name, a feature reducer,
 * a feature selector, a selector for each feature state property, and extra
 * selectors.
 *
 * @usageNotes
 *
 * ```ts
 * interface ProductsState {
 *   products: Product[];
 *   selectedId: string | null;
 * }
 *
 * const initialState: ProductsState = {
 *   products: [],
 *   selectedId: null,
 * };
 *
 * const productsFeature = createFeature({
 *   name: 'products',
 *   reducer: createReducer(
 *     initialState,
 *     on(ProductsApiActions.loadSuccess(state, { products }) => ({
 *       ...state,
 *       products,
 *     }),
 *   ),
 * });
 *
 * const {
 *   name,
 *   reducer,
 *   // feature selector
 *   selectProductsState, // type: MemoizedSelector<Record<string, any>, ProductsState>
 *   // feature state properties selectors
 *   selectProducts, // type: MemoizedSelector<Record<string, any>, Product[]>
 *   selectSelectedId, // type: MemoizedSelector<Record<string, any>, string | null>
 * } = productsFeature;
 * ```
 *
 * **Creating Feature with Extra Selectors**
 *
 * ```ts
 * type CallState = 'init' | 'loading' | 'loaded' | { error: string };
 *
 * interface State extends EntityState<Product> {
 *   callState: CallState;
 * }
 *
 * const adapter = createEntityAdapter<Product>();
 * const initialState: State = adapter.getInitialState({
 *   callState: 'init',
 * });
 *
 * export const productsFeature = createFeature({
 *   name: 'products',
 *   reducer: createReducer(initialState),
 *   extraSelectors: ({ selectProductsState, selectCallState }) => ({
 *     ...adapter.getSelectors(selectProductsState),
 *     ...getCallStateSelectors(selectCallState)
 *   }),
 * });
 *
 * const {
 *   name,
 *   reducer,
 *   // feature selector
 *   selectProductsState,
 *   // feature state properties selectors
 *   selectIds,
 *   selectEntities,
 *   selectCallState,
 *   // selectors returned by `adapter.getSelectors`
 *   selectAll,
 *   selectTotal,
 *   // selectors returned by `getCallStateSelectors`
 *   selectIsLoading,
 *   selectIsLoaded,
 *   selectError,
 * } = productsFeature;
 * ```
 */
export function createFeature(featureConfig) {
    const { name, reducer, extraSelectors: extraSelectorsFactory, } = featureConfig;
    const featureSelector = createFeatureSelector(name);
    const nestedSelectors = createNestedSelectors(featureSelector, reducer);
    const baseSelectors = {
        [`select${capitalize(name)}State`]: featureSelector,
        ...nestedSelectors,
    };
    const extraSelectors = extraSelectorsFactory
        ? extraSelectorsFactory(baseSelectors)
        : {};
    return {
        name,
        reducer,
        ...baseSelectors,
        ...extraSelectors,
    };
}
function createNestedSelectors(featureSelector, reducer) {
    const initialState = getInitialState(reducer);
    const nestedKeys = (isPlainObject(initialState) ? Object.keys(initialState) : []);
    return nestedKeys.reduce((nestedSelectors, nestedKey) => ({
        ...nestedSelectors,
        [`select${capitalize(nestedKey)}`]: createSelector(featureSelector, (parentState) => parentState?.[nestedKey]),
    }), {});
}
function getInitialState(reducer) {
    return reducer(undefined, { type: '@ngrx/feature/init' });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZV9jcmVhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbW9kdWxlcy9zdG9yZS9zcmMvZmVhdHVyZV9jcmVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFdkMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sRUFDTCxxQkFBcUIsRUFDckIsY0FBYyxHQUVmLE1BQU0sWUFBWSxDQUFDO0FBZ0hwQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F5Rkc7QUFDSCxNQUFNLFVBQVUsYUFBYSxDQU0zQixhQU1DO0lBRUQsTUFBTSxFQUNKLElBQUksRUFDSixPQUFPLEVBQ1AsY0FBYyxFQUFFLHFCQUFxQixHQUN0QyxHQUFHLGFBQWEsQ0FBQztJQUVsQixNQUFNLGVBQWUsR0FBRyxxQkFBcUIsQ0FBZSxJQUFJLENBQUMsQ0FBQztJQUNsRSxNQUFNLGVBQWUsR0FBRyxxQkFBcUIsQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDeEUsTUFBTSxhQUFhLEdBQUc7UUFDcEIsQ0FBQyxTQUFTLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsZUFBZTtRQUNuRCxHQUFHLGVBQWU7S0FDOEMsQ0FBQztJQUNuRSxNQUFNLGNBQWMsR0FBRyxxQkFBcUI7UUFDMUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQztRQUN0QyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRVAsT0FBTztRQUNMLElBQUk7UUFDSixPQUFPO1FBQ1AsR0FBRyxhQUFhO1FBQ2hCLEdBQUcsY0FBYztLQUMrQyxDQUFDO0FBQ3JFLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUk1QixlQUF5RCxFQUN6RCxPQUFvQztJQUVwQyxNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUMsTUFBTSxVQUFVLEdBQUcsQ0FDakIsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3ZCLENBQUM7SUFFeEMsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUN0QixDQUFDLGVBQWUsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0IsR0FBRyxlQUFlO1FBQ2xCLENBQUMsU0FBUyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFLGNBQWMsQ0FDaEQsZUFBZSxFQUNmLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FDMUM7S0FDRixDQUFDLEVBQ0YsRUFBNkMsQ0FDOUMsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FDdEIsT0FBb0M7SUFFcEMsT0FBTyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLG9CQUFvQixFQUFFLENBQUMsQ0FBQztBQUM1RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2FwaXRhbGl6ZSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyBBY3Rpb25SZWR1Y2VyLCBQcmltaXRpdmUsIFNlbGVjdG9yIH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHsgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4vbWV0YS1yZWR1Y2Vycy91dGlscyc7XG5pbXBvcnQge1xuICBjcmVhdGVGZWF0dXJlU2VsZWN0b3IsXG4gIGNyZWF0ZVNlbGVjdG9yLFxuICBNZW1vaXplZFNlbGVjdG9yLFxufSBmcm9tICcuL3NlbGVjdG9yJztcblxuZXhwb3J0IGludGVyZmFjZSBGZWF0dXJlQ29uZmlnPEZlYXR1cmVOYW1lIGV4dGVuZHMgc3RyaW5nLCBGZWF0dXJlU3RhdGU+IHtcbiAgbmFtZTogRmVhdHVyZU5hbWU7XG4gIHJlZHVjZXI6IEFjdGlvblJlZHVjZXI8RmVhdHVyZVN0YXRlPjtcbn1cblxudHlwZSBGZWF0dXJlPFxuICBBcHBTdGF0ZSBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4sXG4gIEZlYXR1cmVOYW1lIGV4dGVuZHMga2V5b2YgQXBwU3RhdGUgJiBzdHJpbmcsXG4gIEZlYXR1cmVTdGF0ZSBleHRlbmRzIEFwcFN0YXRlW0ZlYXR1cmVOYW1lXVxuPiA9IEZlYXR1cmVDb25maWc8RmVhdHVyZU5hbWUsIEZlYXR1cmVTdGF0ZT4gJlxuICBCYXNlU2VsZWN0b3JzPEFwcFN0YXRlLCBGZWF0dXJlTmFtZSwgRmVhdHVyZVN0YXRlPjtcblxudHlwZSBGZWF0dXJlV2l0aEV4dHJhU2VsZWN0b3JzPFxuICBGZWF0dXJlTmFtZSBleHRlbmRzIHN0cmluZyxcbiAgRmVhdHVyZVN0YXRlLFxuICBFeHRyYVNlbGVjdG9ycyBleHRlbmRzIFNlbGVjdG9yc0RpY3Rpb25hcnlcbj4gPSBzdHJpbmcgZXh0ZW5kcyBrZXlvZiBFeHRyYVNlbGVjdG9yc1xuICA/IEZlYXR1cmU8UmVjb3JkPHN0cmluZywgYW55PiwgRmVhdHVyZU5hbWUsIEZlYXR1cmVTdGF0ZT5cbiAgOiBPbWl0PFxuICAgICAgRmVhdHVyZTxSZWNvcmQ8c3RyaW5nLCBhbnk+LCBGZWF0dXJlTmFtZSwgRmVhdHVyZVN0YXRlPixcbiAgICAgIGtleW9mIEV4dHJhU2VsZWN0b3JzXG4gICAgPiAmXG4gICAgICBFeHRyYVNlbGVjdG9ycztcblxudHlwZSBGZWF0dXJlU2VsZWN0b3I8XG4gIEFwcFN0YXRlIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PixcbiAgRmVhdHVyZU5hbWUgZXh0ZW5kcyBrZXlvZiBBcHBTdGF0ZSAmIHN0cmluZyxcbiAgRmVhdHVyZVN0YXRlIGV4dGVuZHMgQXBwU3RhdGVbRmVhdHVyZU5hbWVdXG4+ID0ge1xuICBbSyBpbiBGZWF0dXJlTmFtZSBhcyBgc2VsZWN0JHtDYXBpdGFsaXplPEs+fVN0YXRlYF06IE1lbW9pemVkU2VsZWN0b3I8XG4gICAgQXBwU3RhdGUsXG4gICAgRmVhdHVyZVN0YXRlLFxuICAgIChmZWF0dXJlU3RhdGU6IEZlYXR1cmVTdGF0ZSkgPT4gRmVhdHVyZVN0YXRlXG4gID47XG59O1xuXG50eXBlIE5lc3RlZFNlbGVjdG9yczxcbiAgQXBwU3RhdGUgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICBGZWF0dXJlU3RhdGVcbj4gPSBGZWF0dXJlU3RhdGUgZXh0ZW5kcyBQcmltaXRpdmUgfCB1bmtub3duW10gfCBEYXRlXG4gID8ge31cbiAgOiB7XG4gICAgICBbSyBpbiBrZXlvZiBGZWF0dXJlU3RhdGUgJlxuICAgICAgICBzdHJpbmcgYXMgYHNlbGVjdCR7Q2FwaXRhbGl6ZTxLPn1gXTogTWVtb2l6ZWRTZWxlY3RvcjxcbiAgICAgICAgQXBwU3RhdGUsXG4gICAgICAgIEZlYXR1cmVTdGF0ZVtLXSxcbiAgICAgICAgKGZlYXR1cmVTdGF0ZTogRmVhdHVyZVN0YXRlKSA9PiBGZWF0dXJlU3RhdGVbS11cbiAgICAgID47XG4gICAgfTtcblxudHlwZSBCYXNlU2VsZWN0b3JzPFxuICBBcHBTdGF0ZSBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4sXG4gIEZlYXR1cmVOYW1lIGV4dGVuZHMga2V5b2YgQXBwU3RhdGUgJiBzdHJpbmcsXG4gIEZlYXR1cmVTdGF0ZSBleHRlbmRzIEFwcFN0YXRlW0ZlYXR1cmVOYW1lXVxuPiA9IEZlYXR1cmVTZWxlY3RvcjxBcHBTdGF0ZSwgRmVhdHVyZU5hbWUsIEZlYXR1cmVTdGF0ZT4gJlxuICBOZXN0ZWRTZWxlY3RvcnM8QXBwU3RhdGUsIEZlYXR1cmVTdGF0ZT47XG5cbnR5cGUgU2VsZWN0b3JzRGljdGlvbmFyeSA9IFJlY29yZDxcbiAgc3RyaW5nLFxuICB8IFNlbGVjdG9yPFJlY29yZDxzdHJpbmcsIGFueT4sIHVua25vd24+XG4gIHwgKCguLi5hcmdzOiBhbnlbXSkgPT4gU2VsZWN0b3I8UmVjb3JkPHN0cmluZywgYW55PiwgdW5rbm93bj4pXG4+O1xuXG50eXBlIEV4dHJhU2VsZWN0b3JzRmFjdG9yeTxcbiAgRmVhdHVyZU5hbWUgZXh0ZW5kcyBzdHJpbmcsXG4gIEZlYXR1cmVTdGF0ZSxcbiAgRXh0cmFTZWxlY3RvcnMgZXh0ZW5kcyBTZWxlY3RvcnNEaWN0aW9uYXJ5XG4+ID0gKFxuICBiYXNlU2VsZWN0b3JzOiBCYXNlU2VsZWN0b3JzPFJlY29yZDxzdHJpbmcsIGFueT4sIEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGU+XG4pID0+IEV4dHJhU2VsZWN0b3JzO1xuXG50eXBlIE5vdEFsbG93ZWRGZWF0dXJlU3RhdGVDaGVjazxGZWF0dXJlU3RhdGU+ID1cbiAgRmVhdHVyZVN0YXRlIGV4dGVuZHMgUmVxdWlyZWQ8RmVhdHVyZVN0YXRlPlxuICAgID8gdW5rbm93blxuICAgIDogJ29wdGlvbmFsIHByb3BlcnRpZXMgYXJlIG5vdCBhbGxvd2VkIGluIHRoZSBmZWF0dXJlIHN0YXRlJztcblxuLyoqXG4gKiBDcmVhdGVzIGEgZmVhdHVyZSBvYmplY3Qgd2l0aCBleHRyYSBzZWxlY3RvcnMuXG4gKlxuICogQHBhcmFtIGZlYXR1cmVDb25maWcgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgYSBmZWF0dXJlIG5hbWUsIGEgZmVhdHVyZVxuICogcmVkdWNlciwgYW5kIGV4dHJhIHNlbGVjdG9ycyBmYWN0b3J5LlxuICogQHJldHVybnMgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgYSBmZWF0dXJlIG5hbWUsIGEgZmVhdHVyZSByZWR1Y2VyLFxuICogYSBmZWF0dXJlIHNlbGVjdG9yLCBhIHNlbGVjdG9yIGZvciBlYWNoIGZlYXR1cmUgc3RhdGUgcHJvcGVydHksIGFuZFxuICogZXh0cmEgc2VsZWN0b3JzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRmVhdHVyZTxcbiAgRmVhdHVyZU5hbWUgZXh0ZW5kcyBzdHJpbmcsXG4gIEZlYXR1cmVTdGF0ZSxcbiAgRXh0cmFTZWxlY3RvcnMgZXh0ZW5kcyBTZWxlY3RvcnNEaWN0aW9uYXJ5XG4+KFxuICBmZWF0dXJlQ29uZmlnOiBGZWF0dXJlQ29uZmlnPEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGU+ICYge1xuICAgIGV4dHJhU2VsZWN0b3JzOiBFeHRyYVNlbGVjdG9yc0ZhY3Rvcnk8XG4gICAgICBGZWF0dXJlTmFtZSxcbiAgICAgIEZlYXR1cmVTdGF0ZSxcbiAgICAgIEV4dHJhU2VsZWN0b3JzXG4gICAgPjtcbiAgfSAmIE5vdEFsbG93ZWRGZWF0dXJlU3RhdGVDaGVjazxGZWF0dXJlU3RhdGU+XG4pOiBGZWF0dXJlV2l0aEV4dHJhU2VsZWN0b3JzPEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGUsIEV4dHJhU2VsZWN0b3JzPjtcbi8qKlxuICogQ3JlYXRlcyBhIGZlYXR1cmUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSBmZWF0dXJlQ29uZmlnIEFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIGEgZmVhdHVyZSBuYW1lIGFuZCBhIGZlYXR1cmVcbiAqIHJlZHVjZXIuXG4gKiBAcmV0dXJucyBBbiBvYmplY3QgdGhhdCBjb250YWlucyBhIGZlYXR1cmUgbmFtZSwgYSBmZWF0dXJlIHJlZHVjZXIsXG4gKiBhIGZlYXR1cmUgc2VsZWN0b3IsIGFuZCBhIHNlbGVjdG9yIGZvciBlYWNoIGZlYXR1cmUgc3RhdGUgcHJvcGVydHkuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVGZWF0dXJlPEZlYXR1cmVOYW1lIGV4dGVuZHMgc3RyaW5nLCBGZWF0dXJlU3RhdGU+KFxuICBmZWF0dXJlQ29uZmlnOiBGZWF0dXJlQ29uZmlnPEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGU+ICZcbiAgICBOb3RBbGxvd2VkRmVhdHVyZVN0YXRlQ2hlY2s8RmVhdHVyZVN0YXRlPlxuKTogRmVhdHVyZTxSZWNvcmQ8c3RyaW5nLCBhbnk+LCBGZWF0dXJlTmFtZSwgRmVhdHVyZVN0YXRlPjtcbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKiBBIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhIGZlYXR1cmUgbmFtZSBhbmQgYSBmZWF0dXJlIHJlZHVjZXIsIGFuZCBjcmVhdGVzXG4gKiBhIGZlYXR1cmUgc2VsZWN0b3IgYW5kIGEgc2VsZWN0b3IgZm9yIGVhY2ggZmVhdHVyZSBzdGF0ZSBwcm9wZXJ0eS5cbiAqIFRoaXMgZnVuY3Rpb24gYWxzbyBwcm92aWRlcyB0aGUgYWJpbGl0eSB0byBhZGQgZXh0cmEgc2VsZWN0b3JzIHRvXG4gKiB0aGUgZmVhdHVyZSBvYmplY3QuXG4gKlxuICogQHBhcmFtIGZlYXR1cmVDb25maWcgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgYSBmZWF0dXJlIG5hbWUgYW5kIGEgZmVhdHVyZVxuICogcmVkdWNlciBhcyByZXF1aXJlZCwgYW5kIGV4dHJhIHNlbGVjdG9ycyBmYWN0b3J5IGFzIGFuIG9wdGlvbmFsIGFyZ3VtZW50LlxuICogQHJldHVybnMgQW4gb2JqZWN0IHRoYXQgY29udGFpbnMgYSBmZWF0dXJlIG5hbWUsIGEgZmVhdHVyZSByZWR1Y2VyLFxuICogYSBmZWF0dXJlIHNlbGVjdG9yLCBhIHNlbGVjdG9yIGZvciBlYWNoIGZlYXR1cmUgc3RhdGUgcHJvcGVydHksIGFuZCBleHRyYVxuICogc2VsZWN0b3JzLlxuICpcbiAqIEB1c2FnZU5vdGVzXG4gKlxuICogYGBgdHNcbiAqIGludGVyZmFjZSBQcm9kdWN0c1N0YXRlIHtcbiAqICAgcHJvZHVjdHM6IFByb2R1Y3RbXTtcbiAqICAgc2VsZWN0ZWRJZDogc3RyaW5nIHwgbnVsbDtcbiAqIH1cbiAqXG4gKiBjb25zdCBpbml0aWFsU3RhdGU6IFByb2R1Y3RzU3RhdGUgPSB7XG4gKiAgIHByb2R1Y3RzOiBbXSxcbiAqICAgc2VsZWN0ZWRJZDogbnVsbCxcbiAqIH07XG4gKlxuICogY29uc3QgcHJvZHVjdHNGZWF0dXJlID0gY3JlYXRlRmVhdHVyZSh7XG4gKiAgIG5hbWU6ICdwcm9kdWN0cycsXG4gKiAgIHJlZHVjZXI6IGNyZWF0ZVJlZHVjZXIoXG4gKiAgICAgaW5pdGlhbFN0YXRlLFxuICogICAgIG9uKFByb2R1Y3RzQXBpQWN0aW9ucy5sb2FkU3VjY2VzcyhzdGF0ZSwgeyBwcm9kdWN0cyB9KSA9PiAoe1xuICogICAgICAgLi4uc3RhdGUsXG4gKiAgICAgICBwcm9kdWN0cyxcbiAqICAgICB9KSxcbiAqICAgKSxcbiAqIH0pO1xuICpcbiAqIGNvbnN0IHtcbiAqICAgbmFtZSxcbiAqICAgcmVkdWNlcixcbiAqICAgLy8gZmVhdHVyZSBzZWxlY3RvclxuICogICBzZWxlY3RQcm9kdWN0c1N0YXRlLCAvLyB0eXBlOiBNZW1vaXplZFNlbGVjdG9yPFJlY29yZDxzdHJpbmcsIGFueT4sIFByb2R1Y3RzU3RhdGU+XG4gKiAgIC8vIGZlYXR1cmUgc3RhdGUgcHJvcGVydGllcyBzZWxlY3RvcnNcbiAqICAgc2VsZWN0UHJvZHVjdHMsIC8vIHR5cGU6IE1lbW9pemVkU2VsZWN0b3I8UmVjb3JkPHN0cmluZywgYW55PiwgUHJvZHVjdFtdPlxuICogICBzZWxlY3RTZWxlY3RlZElkLCAvLyB0eXBlOiBNZW1vaXplZFNlbGVjdG9yPFJlY29yZDxzdHJpbmcsIGFueT4sIHN0cmluZyB8IG51bGw+XG4gKiB9ID0gcHJvZHVjdHNGZWF0dXJlO1xuICogYGBgXG4gKlxuICogKipDcmVhdGluZyBGZWF0dXJlIHdpdGggRXh0cmEgU2VsZWN0b3JzKipcbiAqXG4gKiBgYGB0c1xuICogdHlwZSBDYWxsU3RhdGUgPSAnaW5pdCcgfCAnbG9hZGluZycgfCAnbG9hZGVkJyB8IHsgZXJyb3I6IHN0cmluZyB9O1xuICpcbiAqIGludGVyZmFjZSBTdGF0ZSBleHRlbmRzIEVudGl0eVN0YXRlPFByb2R1Y3Q+IHtcbiAqICAgY2FsbFN0YXRlOiBDYWxsU3RhdGU7XG4gKiB9XG4gKlxuICogY29uc3QgYWRhcHRlciA9IGNyZWF0ZUVudGl0eUFkYXB0ZXI8UHJvZHVjdD4oKTtcbiAqIGNvbnN0IGluaXRpYWxTdGF0ZTogU3RhdGUgPSBhZGFwdGVyLmdldEluaXRpYWxTdGF0ZSh7XG4gKiAgIGNhbGxTdGF0ZTogJ2luaXQnLFxuICogfSk7XG4gKlxuICogZXhwb3J0IGNvbnN0IHByb2R1Y3RzRmVhdHVyZSA9IGNyZWF0ZUZlYXR1cmUoe1xuICogICBuYW1lOiAncHJvZHVjdHMnLFxuICogICByZWR1Y2VyOiBjcmVhdGVSZWR1Y2VyKGluaXRpYWxTdGF0ZSksXG4gKiAgIGV4dHJhU2VsZWN0b3JzOiAoeyBzZWxlY3RQcm9kdWN0c1N0YXRlLCBzZWxlY3RDYWxsU3RhdGUgfSkgPT4gKHtcbiAqICAgICAuLi5hZGFwdGVyLmdldFNlbGVjdG9ycyhzZWxlY3RQcm9kdWN0c1N0YXRlKSxcbiAqICAgICAuLi5nZXRDYWxsU3RhdGVTZWxlY3RvcnMoc2VsZWN0Q2FsbFN0YXRlKVxuICogICB9KSxcbiAqIH0pO1xuICpcbiAqIGNvbnN0IHtcbiAqICAgbmFtZSxcbiAqICAgcmVkdWNlcixcbiAqICAgLy8gZmVhdHVyZSBzZWxlY3RvclxuICogICBzZWxlY3RQcm9kdWN0c1N0YXRlLFxuICogICAvLyBmZWF0dXJlIHN0YXRlIHByb3BlcnRpZXMgc2VsZWN0b3JzXG4gKiAgIHNlbGVjdElkcyxcbiAqICAgc2VsZWN0RW50aXRpZXMsXG4gKiAgIHNlbGVjdENhbGxTdGF0ZSxcbiAqICAgLy8gc2VsZWN0b3JzIHJldHVybmVkIGJ5IGBhZGFwdGVyLmdldFNlbGVjdG9yc2BcbiAqICAgc2VsZWN0QWxsLFxuICogICBzZWxlY3RUb3RhbCxcbiAqICAgLy8gc2VsZWN0b3JzIHJldHVybmVkIGJ5IGBnZXRDYWxsU3RhdGVTZWxlY3RvcnNgXG4gKiAgIHNlbGVjdElzTG9hZGluZyxcbiAqICAgc2VsZWN0SXNMb2FkZWQsXG4gKiAgIHNlbGVjdEVycm9yLFxuICogfSA9IHByb2R1Y3RzRmVhdHVyZTtcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRmVhdHVyZTxcbiAgQXBwU3RhdGUgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICBGZWF0dXJlTmFtZSBleHRlbmRzIGtleW9mIEFwcFN0YXRlICYgc3RyaW5nLFxuICBGZWF0dXJlU3RhdGUgZXh0ZW5kcyBBcHBTdGF0ZVtGZWF0dXJlTmFtZV0sXG4gIEV4dHJhU2VsZWN0b3JzIGV4dGVuZHMgU2VsZWN0b3JzRGljdGlvbmFyeVxuPihcbiAgZmVhdHVyZUNvbmZpZzogRmVhdHVyZUNvbmZpZzxGZWF0dXJlTmFtZSwgRmVhdHVyZVN0YXRlPiAmIHtcbiAgICBleHRyYVNlbGVjdG9ycz86IEV4dHJhU2VsZWN0b3JzRmFjdG9yeTxcbiAgICAgIEZlYXR1cmVOYW1lLFxuICAgICAgRmVhdHVyZVN0YXRlLFxuICAgICAgRXh0cmFTZWxlY3RvcnNcbiAgICA+O1xuICB9XG4pOiBGZWF0dXJlPEFwcFN0YXRlLCBGZWF0dXJlTmFtZSwgRmVhdHVyZVN0YXRlPiAmIEV4dHJhU2VsZWN0b3JzIHtcbiAgY29uc3Qge1xuICAgIG5hbWUsXG4gICAgcmVkdWNlcixcbiAgICBleHRyYVNlbGVjdG9yczogZXh0cmFTZWxlY3RvcnNGYWN0b3J5LFxuICB9ID0gZmVhdHVyZUNvbmZpZztcblxuICBjb25zdCBmZWF0dXJlU2VsZWN0b3IgPSBjcmVhdGVGZWF0dXJlU2VsZWN0b3I8RmVhdHVyZVN0YXRlPihuYW1lKTtcbiAgY29uc3QgbmVzdGVkU2VsZWN0b3JzID0gY3JlYXRlTmVzdGVkU2VsZWN0b3JzKGZlYXR1cmVTZWxlY3RvciwgcmVkdWNlcik7XG4gIGNvbnN0IGJhc2VTZWxlY3RvcnMgPSB7XG4gICAgW2BzZWxlY3Qke2NhcGl0YWxpemUobmFtZSl9U3RhdGVgXTogZmVhdHVyZVNlbGVjdG9yLFxuICAgIC4uLm5lc3RlZFNlbGVjdG9ycyxcbiAgfSBhcyBCYXNlU2VsZWN0b3JzPFJlY29yZDxzdHJpbmcsIGFueT4sIEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGU+O1xuICBjb25zdCBleHRyYVNlbGVjdG9ycyA9IGV4dHJhU2VsZWN0b3JzRmFjdG9yeVxuICAgID8gZXh0cmFTZWxlY3RvcnNGYWN0b3J5KGJhc2VTZWxlY3RvcnMpXG4gICAgOiB7fTtcblxuICByZXR1cm4ge1xuICAgIG5hbWUsXG4gICAgcmVkdWNlcixcbiAgICAuLi5iYXNlU2VsZWN0b3JzLFxuICAgIC4uLmV4dHJhU2VsZWN0b3JzLFxuICB9IGFzIEZlYXR1cmU8QXBwU3RhdGUsIEZlYXR1cmVOYW1lLCBGZWF0dXJlU3RhdGU+ICYgRXh0cmFTZWxlY3RvcnM7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU5lc3RlZFNlbGVjdG9yczxcbiAgQXBwU3RhdGUgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICBGZWF0dXJlU3RhdGVcbj4oXG4gIGZlYXR1cmVTZWxlY3RvcjogTWVtb2l6ZWRTZWxlY3RvcjxBcHBTdGF0ZSwgRmVhdHVyZVN0YXRlPixcbiAgcmVkdWNlcjogQWN0aW9uUmVkdWNlcjxGZWF0dXJlU3RhdGU+XG4pOiBOZXN0ZWRTZWxlY3RvcnM8QXBwU3RhdGUsIEZlYXR1cmVTdGF0ZT4ge1xuICBjb25zdCBpbml0aWFsU3RhdGUgPSBnZXRJbml0aWFsU3RhdGUocmVkdWNlcik7XG4gIGNvbnN0IG5lc3RlZEtleXMgPSAoXG4gICAgaXNQbGFpbk9iamVjdChpbml0aWFsU3RhdGUpID8gT2JqZWN0LmtleXMoaW5pdGlhbFN0YXRlKSA6IFtdXG4gICkgYXMgQXJyYXk8a2V5b2YgRmVhdHVyZVN0YXRlICYgc3RyaW5nPjtcblxuICByZXR1cm4gbmVzdGVkS2V5cy5yZWR1Y2UoXG4gICAgKG5lc3RlZFNlbGVjdG9ycywgbmVzdGVkS2V5KSA9PiAoe1xuICAgICAgLi4ubmVzdGVkU2VsZWN0b3JzLFxuICAgICAgW2BzZWxlY3Qke2NhcGl0YWxpemUobmVzdGVkS2V5KX1gXTogY3JlYXRlU2VsZWN0b3IoXG4gICAgICAgIGZlYXR1cmVTZWxlY3RvcixcbiAgICAgICAgKHBhcmVudFN0YXRlKSA9PiBwYXJlbnRTdGF0ZT8uW25lc3RlZEtleV1cbiAgICAgICksXG4gICAgfSksXG4gICAge30gYXMgTmVzdGVkU2VsZWN0b3JzPEFwcFN0YXRlLCBGZWF0dXJlU3RhdGU+XG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZTxGZWF0dXJlU3RhdGU+KFxuICByZWR1Y2VyOiBBY3Rpb25SZWR1Y2VyPEZlYXR1cmVTdGF0ZT5cbik6IEZlYXR1cmVTdGF0ZSB7XG4gIHJldHVybiByZWR1Y2VyKHVuZGVmaW5lZCwgeyB0eXBlOiAnQG5ncngvZmVhdHVyZS9pbml0JyB9KTtcbn1cbiJdfQ==